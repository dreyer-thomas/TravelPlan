# Story 2.10: Restore/Import Trip Data from JSON

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a trip planner,
I want to restore or import my trip data from a JSON backup,
so that I can recover plans or migrate between environments.

## Acceptance Criteria

1. **Given** I am signed in
   **When** I import a valid trip JSON backup
   **Then** the trip and all associated data are restored
   **And** I see a success state
2. **Given** the import file is invalid or incomplete
   **When** I attempt to import
   **Then** I see a validation error and no data is overwritten
3. **Given** a trip with the same name already exists
   **When** I import a backup
   **Then** I am prompted to confirm overwrite or create a new trip

## Story Requirements

- Import must accept JSON generated by Story 2.9 export format (`meta`, `trip`, `days`).
- Import must be atomic (all-or-nothing): no partial writes if validation or persistence fails.
- Import must enforce ownership scope: imported records belong only to current session user.
- Import must support duplicate name conflict handling:
  - default behavior: report conflict and require user choice
  - overwrite mode: replace existing user-owned trip data for selected target
  - create-new mode: create a new trip and preserve existing one
- Validation failures must return structured API errors and preserve existing data unchanged.
- Existing trip overview/day-view/export behavior from stories 2.7, 2.9, 2.12, 2.13 must not regress.

## Tasks / Subtasks

- [x] Define import validation schema + conflict contract (AC: 2,3)
  - [x] Add `travelplan/src/lib/validation/tripImportSchemas.ts` for exported payload and conflict mode parsing.
  - [x] Validate required fields (`trip`, `days`, day ordering fields, core nested values) and reject malformed/incomplete payloads.
  - [x] Define API contract for conflict strategy (`overwrite` | `createNew`) and optional target trip id for overwrite flow.
- [x] Repository import transaction (AC: 1,2,3)
  - [x] Add import function(s) in `travelplan/src/lib/repositories/tripRepo.ts` that:
    - parse normalized payload input
    - run full DB write in Prisma transaction
    - map exported accommodation status (`planned/booked`) to Prisma enum (`PLANNED/BOOKED`)
    - maintain deterministic day ordering by `dayIndex` then `date`
  - [x] Overwrite mode must delete/replace target trip data safely inside one transaction.
  - [x] Create-new mode must create a fresh trip + days + accommodations + day plan items.
- [x] Import API route (AC: 1,2,3)
  - [x] Add `POST /api/trips/import` route: `travelplan/src/app/api/trips/import/route.ts`.
  - [x] Require authentication (`401`) and CSRF validation (`403`) following existing state-changing patterns.
  - [x] Accept JSON body (`application/json`) for MVP; return `400` for invalid JSON/validation failures.
  - [x] Return conflict response (`409`) when same-name trip exists and no strategy chosen.
  - [x] Return success envelope with imported trip summary + day count on completion.
- [x] Trip UI import flow (AC: 1,2,3)
  - [x] Add import action in `TripTimeline` controls near export/edit/delete.
  - [x] Implement import dialog (new component) with file picker, parse-and-submit flow, and conflict resolution prompt.
  - [x] Handle two-step UX for conflicts: user selects overwrite or create new and confirms.
  - [x] Localize all new labels/errors in EN/DE dictionaries.
- [x] Tests (AC: 1,2,3)
  - [x] Add route tests `travelplan/test/tripImportRoute.test.ts` for success, auth, csrf, invalid JSON, validation error, conflict response, overwrite/createNew modes.
  - [x] Extend repository tests in `travelplan/test/tripRepo.test.ts` for atomic behavior and nested data restoration.
  - [x] Add UI tests in `travelplan/test/tripTimelinePlan.test.tsx` (or dedicated import test) for import action visibility and conflict handling.

## Dev Notes

- Existing export implementation (Story 2.9) is the canonical source format:
  - `travelplan/src/app/api/trips/[id]/export/route.ts`
  - `travelplan/src/lib/repositories/tripRepo.ts#getTripExportForUser`
- Existing trip details and action controls are in:
  - `travelplan/src/components/features/trips/TripTimeline.tsx`
- API envelope and error conventions:
  - `travelplan/src/lib/http/response.ts`
  - `travelplan/src/lib/errors/apiError.ts`
- CSRF pattern for state-changing routes:
  - `travelplan/src/lib/security/csrf.ts`
  - `travelplan/src/app/api/trips/route.ts` and `travelplan/src/app/api/trips/[id]/route.ts`

### Project Structure Notes

- Expected touch points:
  - `travelplan/src/app/api/trips/import/route.ts` (new)
  - `travelplan/src/lib/validation/tripImportSchemas.ts` (new)
  - `travelplan/src/lib/repositories/tripRepo.ts`
  - `travelplan/src/components/features/trips/TripTimeline.tsx`
  - `travelplan/src/components/features/trips/TripImportDialog.tsx` (new)
  - `travelplan/src/i18n/en.ts`
  - `travelplan/src/i18n/de.ts`
  - `travelplan/test/tripImportRoute.test.ts` (new)
  - `travelplan/test/tripRepo.test.ts`
  - `travelplan/test/tripTimelinePlan.test.tsx` (or new dedicated import UI test)

### References

- `/Users/tommy/Development/TravelPlan/_bmad-output/planning-artifacts/epics.md#Story 2.10: Restore/Import Trip Data from JSON`
- `/Users/tommy/Development/TravelPlan/_bmad-output/planning-artifacts/prd.md#Data Safety`
- `/Users/tommy/Development/TravelPlan/_bmad-output/planning-artifacts/architecture.md#API & Communication Patterns`
- `/Users/tommy/Development/TravelPlan/_bmad-output/implementation-artifacts/2-9-export-trip-backup-as-json.md`
- [Next.js Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
- [Zod Basics](https://zod.dev/basics)
- [MDN JSON.parse](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse)

## Developer Context

### Data Model

- Import payload target entities and relationships (existing schema only, no migration):
  - `Trip`
  - `TripDay`
  - `Accommodation` (0..1 per day)
  - `DayPlanItem` (0..n per day)
- `TripDay.dayIndex` and `TripDay.date` must remain coherent and ordered.
- Persist nullable fields exactly when provided (`linkUrl`, `location`, `notes`, `heroImageUrl`).

### API Shape

- Route: `POST /api/trips/import`
- Request body (MVP):
  - `payload`: exported trip JSON object
  - optional conflict inputs: `strategy`, `targetTripId`
- Response envelope:
  - success: `{ data: { trip, dayCount, mode }, error: null }`
  - conflict: `409` + `{ data: null, error: { code: "trip_name_conflict", details: ... } }`
  - validation/auth/csrf/server errors follow existing envelope conventions

### UI Behavior

- Import action is available from trip detail timeline action row.
- User flow:
  - select JSON file
  - submit import
  - if conflict returned, choose overwrite or create new and confirm
  - success refreshes detail/list context and shows success feedback
- Errors must be localized and non-destructive.

### Validation Rules

- Require session cookie auth for import route.
- Require CSRF token for `POST`.
- Reject non-object payloads and malformed nested data.
- Reject incomplete day records (missing required fields) before any DB write.

## Technical Requirements

- Keep pinned stack from repository:
  - Next.js `16.1.6`
  - Prisma `7.3.0`
  - React `19.2.3`
  - Zod `4.1.11`
- No dependency upgrades in this story.

## Architecture Compliance

- API route stays under `src/app/api/**/route.ts`.
- Repository remains sole DB access layer; route orchestrates auth/validation/HTTP mapping.
- Use Prisma transaction for atomic import guarantees.
- Keep API response envelope `{ data, error }` for import route responses.

## Library & Framework Requirements

- Use Next.js App Router route handlers for import endpoint.
- Use Zod schemas for payload validation before repository writes.
- Use existing CSRF helper (`validateCsrf`) for state-changing request guard.
- Use existing MUI dialog/button conventions in trip timeline controls.

## File Structure Requirements

- Add one route under `src/app/api/trips/import/route.ts`; do not duplicate existing trip route logic.
- Keep import parsing/normalization reusable in `lib/validation` + `lib/repositories`.
- Keep tests in established `travelplan/test/` patterns.

## Testing Requirements

- Route tests:
  - authenticated + valid payload import succeeds
  - unauthenticated request returns `401`
  - invalid CSRF returns `403`
  - malformed JSON / invalid payload returns `400`
  - same-name conflict returns `409` unless strategy provided
  - overwrite strategy replaces target trip data atomically
  - create-new strategy preserves existing trip and creates another
- Repository tests:
  - nested restore includes day ordering, accommodation, day plan items
  - atomic rollback verified on forced failure (no partial persisted records)
- UI tests:
  - import action visible and opens dialog
  - conflict flow allows strategy selection and retries request
  - localized error/success feedback rendered

## Previous Story Intelligence

- Story 2.9 established export format, owner-only scoping, deterministic ordering, and trip timeline export UI action.
- Reuse the same payload shape and serialization expectations from `getTripExportForUser`.
- Keep import additive to timeline actions and avoid regressions to existing edit/delete/export/day navigation controls.

## Git Intelligence Summary

- Recent implementation trend is additive work in trip/day features and stable API route layering:
  - `8e3939c Story 2.13 day view plan items`
  - `0f5668c Story 2.7 Create and edit day plan`
  - `f56a91b Story 2.5 Add accomodation`
- Continue established pattern: route guards + repository transaction + focused tests per feature route.

## Latest Technical Information

- Next.js App Router route handlers support request body parsing (`request.json()` / `request.formData()`) and are the correct surface for import endpoints.
- Zod v4 docs confirm schema-first parsing and structured validation error handling suitable for strict import validation.
- `JSON.parse` throws for invalid JSON and should be wrapped in route-level error handling before validation.

## Project Context Reference

No `project-context.md` was found. Story context uses:
- `/Users/tommy/Development/TravelPlan/_bmad-output/planning-artifacts/epics.md`
- `/Users/tommy/Development/TravelPlan/_bmad-output/planning-artifacts/prd.md`
- `/Users/tommy/Development/TravelPlan/_bmad-output/planning-artifacts/architecture.md`
- `/Users/tommy/Development/TravelPlan/_bmad-output/planning-artifacts/ux-design-specification.md`
- `/Users/tommy/Development/TravelPlan/_bmad-output/implementation-artifacts/2-9-export-trip-backup-as-json.md`

## Story Completion Status

- Status set to **done**.
- Completion note: Review findings remediated (validation completeness, conflict-safe overwrite targeting, conflict target UX, stronger rollback test).

## Dev Agent Record

### Agent Model Used

Codex (GPT-5)

### Debug Log References

- Added `tripImportSchemas` validation contract and tests.
- Added repository import transaction flow with conflict detection and overwrite/create-new modes.
- Added `POST /api/trips/import` route with auth, CSRF, validation, and conflict response handling.
- Added `TripImportDialog` and integrated import action into `TripTimeline`.
- Hardened validation to reject incomplete day coverage and duplicate `dayIndex` values.
- Restricted overwrite imports to a conflict-selected target trip.
- Added conflict target selector UI for overwrite resolution.
- Strengthened rollback test to fail after trip create and verify full transaction rollback.
- Ran targeted tests and full suite (`npm test`).
- Ran lint (`npm run lint`) with warnings only, no errors.

### Completion Notes List

- Implemented strict import payload + strategy schemas in `travelplan/src/lib/validation/tripImportSchemas.ts`.
- Implemented atomic repository import in `travelplan/src/lib/repositories/tripRepo.ts` with deterministic day sorting and status mapping (`planned/booked` → `PLANNED/BOOKED`).
- Implemented import API endpoint `travelplan/src/app/api/trips/import/route.ts` with `401/403/400/409/200` behavior and `{ data, error }` envelopes.
- Implemented UI flow with `travelplan/src/components/features/trips/TripImportDialog.tsx` and wired action into `travelplan/src/components/features/trips/TripTimeline.tsx`.
- Added conflict target selection UI so overwrite applies to explicit user-selected same-name trip.
- Localized import UI labels/errors in both `travelplan/src/i18n/en.ts` and `travelplan/src/i18n/de.ts`.
- Added/updated tests:
  - `travelplan/test/tripImportSchemas.test.ts`
  - `travelplan/test/tripRepo.test.ts`
  - `travelplan/test/tripImportRoute.test.ts`
  - `travelplan/test/tripTimelinePlan.test.tsx`
  - `travelplan/test/tripImportDialog.test.tsx`
- Validation results:
  - `npm test`: **165 passed, 0 failed**
  - `npm run lint`: **0 errors, warnings only (pre-existing + non-blocking)**

## Senior Developer Review (AI)

- Outcome: **Changes Requested → Fixed**
- High issues remediated:
  - Overwrite target now must be selected from same-name conflict set.
  - Payload validation now rejects incomplete date-range day coverage.
- Medium issues remediated:
  - Conflict UX now supports explicit overwrite target selection.
  - Rollback test now verifies transaction rollback after failure past trip creation.
- Verification:
  - `npm test -- tripImportSchemas.test.ts tripImportRoute.test.ts tripImportDialog.test.tsx tripTimelinePlan.test.tsx tripRepo.test.ts` (35/35 passing)
  - `npm test` (165/165 passing)

### File List

- _bmad-output/implementation-artifacts/2-10-restore-import-trip-data-from-json.md
- _bmad-output/implementation-artifacts/sprint-status.yaml
- travelplan/src/lib/validation/tripImportSchemas.ts
- travelplan/test/tripImportSchemas.test.ts
- travelplan/src/lib/repositories/tripRepo.ts
- travelplan/test/tripRepo.test.ts
- travelplan/src/app/api/trips/import/route.ts
- travelplan/test/tripImportRoute.test.ts
- travelplan/src/components/features/trips/TripImportDialog.tsx
- travelplan/src/components/features/trips/TripTimeline.tsx
- travelplan/src/i18n/en.ts
- travelplan/src/i18n/de.ts
- travelplan/test/tripTimelinePlan.test.tsx
- travelplan/test/tripImportDialog.test.tsx

## Change Log

- 2026-02-14: Created Story 2.10 ready-for-dev context file with API/repository/UI/test implementation guidance.
- 2026-02-14: Implemented Story 2.10 import feature (schema/repo/route/UI), added tests, and marked story ready for review.
- 2026-02-14: Applied code-review fixes for overwrite conflict safety, import completeness validation, conflict overwrite target selection UX, and rollback test hardening; set story to done.
